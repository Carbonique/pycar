- hosts: all
  remote_user: dietpi

  vars:
    default_user_new_password: dietpi #this is by no means secure (a vault would be), but it does not matter much at this point of the pycar project
    ansible_password: dietpi

  tasks:
  - name: "Change default user password"
    user:
      name: dietpi
      password: "{{ default_user_new_password | password_hash('sha512') }}"
      update_password: always

  - name: Disable root login over SSH
    lineinfile: dest=/etc/ssh/sshd_config regexp="^PermitRootLogin" line="PermitRootLogin no" state=present
    notify:
      - restart ssh

  - name: Disable password login
    lineinfile: dest=/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present
    notify:
      - restart ssh
  
  - name: "Set ssh key for default user copying it from current user on Ansible controller"
    ansible.posix.authorized_key:
      user: dietpi
      state: present
      key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"

  - name: Install pip 
    package:
      name: pip
      state: present

  - name: Install pip virtualenv
    pip:
      name: virtualenv
      state: present

  handlers:
  - name: restart ssh
    command: sudo systemctl restart ssh